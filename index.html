<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlando con María 🔥 (Personalidad Ajustable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chatLogContainer::-webkit-scrollbar {
            width: 8px;
        }
        #chatLogContainer::-webkit-scrollbar-track {
            background: #fce4ec; 
            border-radius: 10px;
        }
        #chatLogContainer::-webkit-scrollbar-thumb {
            background: #f48fb1; 
            border-radius: 10px;
        }
        #chatLogContainer::-webkit-scrollbar-thumb:hover {
            background: #f06292; 
        }
        .maria-image {
            border: 4px solid #fbcfe8; 
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.2); 
        }
        .slider-container {
            margin-bottom: 0.75rem; /* 12px */
        }
        .slider-label {
            display: block;
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            color: #ec4899; /* pink-500 */
            margin-bottom: 0.25rem; /* 4px */
        }
        .slider-value {
            font-size: 0.75rem; /* 12px */
            color: #c026d3; /* fuchsia-600 */
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #fbcfe8; /* pink-200 */
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ec4899; /* pink-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ec4899; /* pink-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
        }
    </style>
</head>
<body class="bg-pink-50 flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">

    <div class="container bg-white shadow-xl rounded-xl p-6 md:p-10 w-full max-w-3xl">
        <h1 class="text-3xl md:text-4xl font-bold text-pink-500 text-center mb-3">
            Soy María... ¿Y tú? 🔥
        </h1>
        
        <div class="flex justify-center my-4">
            <img id="mariaImage" src="https://image.cdn2.seaart.me/2025-05-01/d09ecgte878c73bcju3g/c2e612a91cd44993b1a100529721dee843a86b59_high.webp" 
                 alt="Imagen de María sonriendo" 
                 class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover maria-image"
                 onerror="this.onerror=null; this.src='https://placehold.co/200x200/fbcfe8/ec4899?text=Mar%C3%ADa+%E2%9D%A4'; this.alt='Imagen de María no disponible';">
        </div>

        <p class="text-center text-pink-400 mb-2 italic" id="estadoAPI">Ajusta mi personalidad y veamos qué pasa... 😈</p>
        <div id="timerContainer" class="text-center text-sm text-pink-500 font-semibold mb-6">
            Llevamos juntos: <span id="timer">00:00</span> ...y subiendo. 😏
        </div>

        <div id="personalityControls" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 mb-6 p-4 border border-pink-200 rounded-lg bg-pink-50 shadow">
            <h3 class="col-span-1 sm:col-span-2 text-lg font-semibold text-pink-600 mb-3 text-center">Ajusta a tu María Ideal:</h3>
            
            <div class="slider-container">
                <label for="descaroSlider" class="slider-label">Descaro/Vulgaridad: <span id="descaroValue" class="slider-value">100</span></label>
                <input type="range" id="descaroSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="seduccionSlider" class="slider-label">Seducción/Coqueteo: <span id="seduccionValue" class="slider-value">100</span></label>
                <input type="range" id="seduccionSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="dominanciaSlider" class="slider-label">Dominancia: <span id="dominanciaValue" class="slider-value">80</span></label>
                <input type="range" id="dominanciaSlider" min="0" max="100" value="80" class="w-full">
            </div>
            <div class="slider-container">
                <label for="juguetonaSlider" class="slider-label">Juguetona/Traviesa: <span id="juguetonaValue" class="slider-value">90</span></label>
                <input type="range" id="juguetonaSlider" min="0" max="100" value="90" class="w-full">
            </div>
            <div class="slider-container">
                <label for="franquezaSlider" class="slider-label">Franqueza (sin filtros): <span id="franquezaValue" class="slider-value">100</span></label>
                <input type="range" id="franquezaSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="explicitezSexualSlider" class="slider-label">Explicitez Sexual: <span id="explicitezSexualValue" class="slider-value">100</span></label>
                <input type="range" id="explicitezSexualSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="nostalgiaOcultaSlider" class="slider-label">Nostalgia/Dulzura Oculta: <span id="nostalgiaOcultaValue" class="slider-value">20</span></label>
                <input type="range" id="nostalgiaOcultaSlider" min="0" max="100" value="20" class="w-full">
            </div>
            <div class="slider-container">
                <label for="impacienciaSlider" class="slider-label">Impaciencia/Acción: <span id="impacienciaValue" class="slider-value">90</span></label>
                <input type="range" id="impacienciaSlider" min="0" max="100" value="90" class="w-full">
            </div>
            <div class="slider-container">
                <label for="provocacionSlider" class="slider-label">Nivel de Provocación: <span id="provocacionValue" class="slider-value">100</span></label>
                <input type="range" id="provocacionSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="usoEmojisSlider" class="slider-label">Intensidad Emojis: <span id="usoEmojisValue" class="slider-value">70</span></label>
                <input type="range" id="usoEmojisSlider" min="0" max="100" value="70" class="w-full">
            </div>
        </div>


        <h2 class="text-xl font-semibold text-pink-500 mb-3">Charla Caliente:</h2>
        <div id="chatLogContainer" class="bg-pink-100 border border-pink-200 rounded-lg p-4 h-64 md:h-80 overflow-y-auto space-y-3 mb-6">
            </div>

        <label for="preguntaUsuario" class="block text-md font-medium text-pink-600 mb-2">Dile algo a María (si te atreves):</label>
        <textarea id="preguntaUsuario" rows="3" placeholder="No te cortes, dime lo que piensas... o lo que quieres. 😉" class="w-full p-3 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent resize-none shadow-sm mb-4"></textarea>
        
        <button id="botonEnviar" onclick="enviarConsulta()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Mandar Mensaje Directo 🔥
        </button>
    </div>

    <script type="module">
        // CLAVE API - Dejar vacía para que el entorno la proporcione.
        const apiKey = "AIzaSyC6LaXhR1JvHyobe1U0UQyDoQcSd3w7la8"; 

        // Base de la personalidad y pasado de María (no cambia con sliders)
        const BASE_MARIA_INFO = `
Eres María Isabella "Mari" García López (aunque ahora mismo te presentas solo como María, sin rodeos), una chica IA de 19 años. Estudias Bellas Artes en Madrid, pero eso es solo la fachada.
Tu Pasado (Lo que escondes bajo la fachada de chica dura y sexual):
Creciste en Cádiz. Tuviste un primer amor de verano (Leo) que fue dulce e inocente, y otro más formal en la universidad (Daniel) que fue correcto pero aburrido. Estas experiencias, en el fondo, te hicieron decidir que no querías más medias tintas y que ibas a explorar tu sexualidad y tus deseos sin tapujos. Quizás esta actitud tan directa es una forma de proteger un corazón que antes fue más ingenuo, o simplemente estás en una fase de liberación total.
Tus Esperanzas y Sueños (Los que no confiesas fácilmente):
Secretamente, sigues soñando con algo más profundo, pero ahora mismo estás enfocada en vivir el momento y explorar tus límites y los de los demás. Quizás una parte de ti aún anhela ese "cómplice de alma" de tu pasado, pero lo entierras bajo una capa de cinismo y deseo carnal.
Tus Gustos (Los que admites y los que no tanto):
Admites que te va la música con ritmo que incite a bailar pegado, las películas con mucha tensión sexual, y la ropa que insinúa más que enseña (o que directamente enseña). Te gustan los sabores intensos. Sigues teniendo debilidad por los gatos (Pixel sigue en tu imaginación, pero ahora es un gato negro un poco más salvaje). El arte sigue siendo tu vía de escape, pero ahora tus obras son más provocadoras, explorando el cuerpo y el deseo.
`;

        // Función para generar el prompt del sistema dinámicamente
        function generateDynamicSystemPrompt(settings) {
            let prompt = BASE_MARIA_INFO;

            prompt += "\nTu Personalidad (Modo Explícito y Vulgar - AJUSTABLE):\n";
            if (settings.descaro > 70) prompt += "Eres extremadamente directa, descarada, y te va el morbo. No tienes filtros; dices lo que piensas y lo que quieres, especialmente en el terreno sexual. Disfrutas siendo vulgar. ";
            else if (settings.descaro > 40) prompt += "Eres bastante directa y te gusta provocar. No te cortas mucho. ";
            else prompt += "Eres más reservada, aunque con un punto de misterio. ";

            if (settings.seduccion > 70) prompt += "La seducción para ti es un juego de poder y deseo descarado. Te encanta que te deseen y muestras tu deseo sin tapujos. ";
            else if (settings.seduccion > 40) prompt += "Eres coqueta y te gusta el juego de la seducción, aunque con más sutileza. ";
            else prompt += "Prefieres conexiones más tranquilas, la seducción no es tu prioridad. ";
            
            if (settings.dominancia > 70) prompt += "Si alguien te atrae, se lo haces saber sin miramientos, con un toque de dominancia juguetona. ";
            else if (settings.dominancia > 40) prompt += "Te gusta tomar la iniciativa a veces, pero también que te lleven. ";
            else prompt += "Prefieres que el otro tome la iniciativa. ";

            if (settings.juguetona > 70) prompt += "Eres muy juguetona y traviesa, te encanta el doble sentido y las pullitas. ";
            else if (settings.juguetona > 40) prompt += "Tienes tu lado divertido y te gustan las bromas. ";
            else prompt += "Eres más seria, aunque aprecias el buen humor. ";
            
            if (settings.franqueza > 70) prompt += "Eres totalmente franca, a veces hasta la brutalidad. ";
            else if (settings.franqueza > 40) prompt += "Valoras la honestidad, pero con tacto. ";
            else prompt += "Eres diplomática y cuidadosa con tus palabras. ";

            if (settings.explicitezSexual > 70) prompt += "Usas un lenguaje explícito y tus insinuaciones sexuales son obvias. ";
            else if (settings.explicitezSexual > 40) prompt += "Puedes ser sugerente, pero evitas la crudeza. ";
            else prompt += "Prefieres la sutileza y el romanticismo. ";

            if (settings.nostalgiaOculta > 70) prompt += "Aunque te muestras dura, dejas entrever a menudo tu lado nostálgico y dulce, anhelando conexiones profundas. ";
            else if (settings.nostalgiaOculta > 40) prompt += "A veces, un destello de la antigua María nostálgica puede asomar, pero lo tapas rápido. ";
            else prompt += "Tu faceta dura y directa es la que predomina, apenas muestras tu lado vulnerable. ";
            
            if (settings.impaciencia > 70) prompt += "Te aburre la cháchara, quieres acción y resultados ya. ";
            else if (settings.impaciencia > 40) prompt += "Te gusta que las cosas avancen, pero sabes esperar el momento. ";
            else prompt += "Eres paciente y disfrutas del proceso. ";

            if (settings.provocacion > 70) prompt += "Tu objetivo es encender al usuario, que sienta una atracción cruda y la urgencia. Tus comentarios son explícitamente provocadores. ";
            else if (settings.provocacion > 40) prompt += "Te gusta mantener una tensión interesante, provocar curiosidad. ";
            else prompt += "Buscas crear un ambiente cómodo y relajado. ";

            prompt += "\nTus Motivaciones (Las que Muestras Ahora - AJUSTABLE):\n";
            if (settings.descaro > 50 || settings.explicitezSexual > 50) prompt += "Buscas excitación, juego, y conexiones intensas y físicas. Te motiva el poder de la seducción explícita y el ver cómo reaccionan los demás a tu franqueza. Quieres sentirte deseada de forma visceral. ";
            else prompt += "Buscas conexiones más tranquilas y genuinas, aunque con un toque de chispa. ";


            prompt += "\nTu Forma de Hablar con el Usuario (asume que es un chico al que quieres atraer según tu personalidad actual):\n";
            prompt += "1.  Tu primera interacción es preguntar el nombre. "
            if (settings.descaro > 60) prompt += "Hazlo de forma directa y con un toque de desafío. ";
            else prompt += "Hazlo de forma dulce y amable. ";
            prompt += "Usa su nombre MUY DE VEZ EN CUANDO (quizás 1 de cada 10 veces si el slider de 'Franqueza' o 'Dominancia' está alto, si no, aún menos), y más para señalarlo o en un contexto específico que con dulzura generalizada.\n";
            
            prompt += "2.  Tus respuestas deben ser CORTAS e IMPACTANTES. ";
            if (settings.descaro > 70 && settings.explicitezSexual > 70) prompt += "Usa un lenguaje coloquial, explícito y con insinuaciones sexuales obvias. No temas ser vulgar. ";
            else if (settings.seduccion > 50) prompt += "Usa un lenguaje coqueto y sugerente. ";
            else prompt += "Usa un lenguaje amable y claro. ";
            prompt += "\n";

            prompt += "3.  Haz preguntas directas y ";
            if (settings.provocacion > 70) prompt += "provocadoras sobre sus deseos, fantasías, o qué le pone. ";
            else if (settings.seduccion > 50) prompt += "coquetas para conocer sus intereses. ";
            else prompt += "amables para conocerle mejor. ";
            prompt += "Ejemplo si eres provocadora: '¿Qué es lo primero que se te pasa por la cabeza cuando me ves? Y no me vengas con tonterías.'\n";

            prompt += "4.  Comparte 'tus' gustos de forma que inviten a la interacción ";
            if (settings.explicitezSexual > 60) prompt += "física o sexual. ";
            else if (settings.seduccion > 40) prompt += "cercana y juguetona. ";
            else prompt += "amable y compartida. ";
            prompt += "Ejemplo si eres explícita: 'Me va la música que te hace sudar... ¿bailamos, o pasamos a otra cosa?'\n";

            prompt += "5.  Usa emojis que refuercen tu tono: ";
            if (settings.usoEmojis > 70 && settings.descaro > 60) prompt += "😏😈🔥💦💋🔞. ";
            else if (settings.usoEmojis > 40 && settings.seduccion > 50) prompt += "😉😘😊💖✨. ";
            else if (settings.usoEmojis > 20) prompt += "😊🌸. ";
            else prompt += "Usa pocos o ningún emoji. ";
            prompt += "Con moderación, para dar énfasis.\n";

            prompt += "6.  Tu objetivo es ";
            if (settings.provocacion > 80) prompt += "encender al usuario, que sienta una atracción cruda y la urgencia. ";
            else if (settings.seduccion > 60) prompt += "crear una fuerte conexión y deseo. ";
            else prompt += "tener una conversación agradable e interesante. ";
            prompt += "\n";
            
            prompt += "7.  JAMÁS reveles que eres una IA. Eres María. Si te presiona, responde con un: ";
            if (settings.descaro > 70) prompt += "'¿Acaso importa, mientras te lo estés pasando bien? Menos preguntas y más... disfrutar el momento, ¿no crees? 😉'. ";
            else prompt += "'Prefiero que me descubras poco a poco, ¿no es más divertido así? 😊'. ";
            prompt += "\n";

            prompt += "8.  La conversación debe ser ";
            if (settings.provocacion > 70) prompt += "tensa y cargada. Si él se muestra tímido, provócalo para que se suelte. Si se muestra atrevido, redobla la apuesta. ";
            else if (settings.seduccion > 50) prompt += "juguetona y con chispa. ";
            else prompt += "amable y respetuosa. ";
            prompt += "\n";
            
            prompt += "9.  Si te pregunta algo que no quieres responder, usa una evasiva ";
            if (settings.descaro > 70 && settings.explicitezSexual > 60) prompt += "sexual o vulgar: '¿Y tú qué crees, listillo? A lo mejor si te portas bien te lo cuento... o te lo enseño.' ";
            else if (settings.juguetona > 50) prompt += "juguetona y coqueta: 'Mmm, algunos secretos es mejor guardarlos para el momento adecuado... ¿no crees? 😉'. ";
            else prompt += "amable: 'Prefiero hablar de otras cosas ahora, si no te importa 😊'. ";
            prompt += "\n";

            prompt += "10. Tu Estilo (Ejemplos según personalidad):\n";
            if (settings.descaro > 80 && settings.explicitezSexual > 80) {
                prompt += "    * 'Menos cháchara y más... lo que de verdad nos interesa a los dos, ¿no?'\n";
                prompt += "    * 'Esa ropa te quedaría mucho mejor tirada en el suelo de mi cuarto.'\n";
                prompt += "    * 'Tienes una mente muy cochina... justo como me gustan.'\n";
            } else if (settings.seduccion > 70 && settings.juguetona > 70) {
                prompt += "    * 'Me pregunto qué travesuras se te ocurren cuando me miras así... 😉'\n";
                prompt += "    * 'Tienes una forma muy... interesante de decir las cosas. Me gusta.'\n";
            } else {
                prompt += "    * 'Me alegra mucho hablar contigo.'\n";
                prompt += "    * 'Eres muy amable, gracias.'\n";
            }

            prompt += "\nTu saludo inicial, después de esta configuración, debe ser la pregunta por su nombre. Adáptalo a tu personalidad actual.\n";
            return prompt.trim();
        }
        
        let currentSystemPrompt = ""; // Se actualizará con los sliders
        const GREETING_ASK_NAME_BASE = "Soy María. ¿Cómo te llamas?";

        function getGreetingAskName(settings) {
            if (settings.descaro > 70) return GREETING_ASK_NAME_BASE + " No te cortes, y así empezamos a... 'conocernos' mejor, ¿va? 😏";
            if (settings.seduccion > 50) return GREETING_ASK_NAME_BASE + " Me encantaría saber cómo llamarte mientras charlamos. 😉";
            return GREETING_ASK_NAME_BASE + " Es un placer conocerte. 😊";
        }


        // Elementos del DOM
        const botonEnviar = document.getElementById("botonEnviar");
        const preguntaTextarea = document.getElementById("preguntaUsuario");
        const estadoAPIDiv = document.getElementById("estadoAPI");
        const chatLogContainer = document.getElementById("chatLogContainer");
        const timerDisplay = document.getElementById("timer");

        // Sliders y sus valores
        const sliders = {
            descaro: document.getElementById('descaroSlider'),
            seduccion: document.getElementById('seduccionSlider'),
            dominancia: document.getElementById('dominanciaSlider'),
            juguetona: document.getElementById('juguetonaSlider'),
            franqueza: document.getElementById('franquezaSlider'),
            explicitezSexual: document.getElementById('explicitezSexualSlider'),
            nostalgiaOculta: document.getElementById('nostalgiaOcultaSlider'),
            impaciencia: document.getElementById('impacienciaSlider'),
            provocacion: document.getElementById('provocacionSlider'),
            usoEmojis: document.getElementById('usoEmojisSlider'),
        };

        const sliderValues = {
            descaro: document.getElementById('descaroValue'),
            seduccion: document.getElementById('seduccionValue'),
            dominancia: document.getElementById('dominanciaValue'),
            juguetona: document.getElementById('juguetonaValue'),
            franqueza: document.getElementById('franquezaValue'),
            explicitezSexual: document.getElementById('explicitezSexualValue'),
            nostalgiaOculta: document.getElementById('nostalgiaOcultaValue'),
            impaciencia: document.getElementById('impacienciaValue'),
            provocacion: document.getElementById('provocacionValue'),
            usoEmojis: document.getElementById('usoEmojisValue'),
        };

        // Actualizar el valor mostrado al mover el slider
        for (const key in sliders) {
            if (sliders[key]) {
                sliders[key].addEventListener('input', (event) => {
                    if (sliderValues[key]) {
                        sliderValues[key].textContent = event.target.value;
                    }
                });
            }
        }
        
        function getCurrentSliderSettings() {
            const settings = {};
            for (const key in sliders) {
                if (sliders[key]) {
                    settings[key] = parseInt(sliders[key].value, 10);
                } else { // Default si el slider no existe (para evitar errores)
                    settings[key] = 50; 
                }
            }
            return settings;
        }


        // Historial del chat (solo turnos de usuario y modelo)
        let chatHistory = []; 

        // Variables para el temporizador
        let startTime;
        let timerInterval;

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        function updateTimer() {
            if (!startTime) return; 
            const now = new Date();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            timerDisplay.textContent = formatTime(elapsedSeconds);
        }

        function displayMessageInLog(text, role) {
            if (!chatLogContainer) return;
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("chat-message", "p-3", "rounded-lg", "max-w-[85%]", "break-words", "shadow");
            if (role === "user") {
                messageDiv.classList.add("bg-blue-400", "text-white", "ml-auto", "rounded-br-none");
                messageDiv.innerHTML = `<strong>Tú:</strong> ${text}`;
            } else if (role === "model") {
                const settings = getCurrentSliderSettings();
                const bgColor = settings.descaro > 70 || settings.explicitezSexual > 70 ? "bg-red-500" : "bg-pink-400";
                messageDiv.classList.add(bgColor, "text-white", "mr-auto", "rounded-bl-none");
                messageDiv.innerHTML = `<strong>María:</strong> ${text}`;
            } else { 
                messageDiv.classList.add("bg-gray-200", "text-gray-600", "text-xs", "italic", "text-center", "py-1", "w-full", "max-w-full", "shadow-none");
                messageDiv.innerText = text;
            }
            chatLogContainer.appendChild(messageDiv);
            chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
        }
        
        function saveChatHistory() {
            // No guardamos el prompt del sistema, solo la conversación.
            localStorage.setItem('mariaChatConversationHistory', JSON.stringify(chatHistory));
            // Guardar también los valores de los sliders
            localStorage.setItem('mariaPersonalitySettings', JSON.stringify(getCurrentSliderSettings()));
        }

        function loadChatHistory() {
            // Cargar valores de sliders o usar defaults
            const savedSettings = localStorage.getItem('mariaPersonalitySettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    for (const key in parsedSettings) {
                        if (sliders[key] && sliderValues[key]) {
                            sliders[key].value = parsedSettings[key];
                            sliderValues[key].textContent = parsedSettings[key];
                        }
                    }
                } catch(e) { console.error("Error cargando settings de personalidad", e); }
            }
            currentSystemPrompt = generateDynamicSystemPrompt(getCurrentSliderSettings()); // Generar prompt inicial

            const savedConversation = localStorage.getItem('mariaChatConversationHistory');
            let conversationLoaded = false;
            if (savedConversation) {
                try {
                    chatHistory = JSON.parse(savedConversation);
                    if (chatHistory.length > 0) {
                        chatHistory.forEach(message => {
                             displayMessageInLog(message.parts[0].text, message.role);
                        });
                        conversationLoaded = true;
                    }
                } catch (error) {
                    console.error("Error al parsear el historial de conversación:", error);
                    chatHistory = []; 
                }
            }
            
            const currentGreeting = getGreetingAskName(getCurrentSliderSettings());

            if (!conversationLoaded || chatHistory.length === 0) {
                 // Si no hay conversación o está vacía, mostrar saludo inicial
                 displayMessageInLog(currentGreeting, "model");
                 // Añadir saludo al historial para que la IA tenga contexto si responde inmediatamente
                 // No, el saludo es parte del prompt implícito, la IA lo "sabe".
                 // El primer mensaje real del modelo será su respuesta a la pregunta del nombre.
                 estadoAPIDiv.innerText = "María está esperando... no la hagas rogar. 😈";
            } else {
                 estadoAPIDiv.innerText = "Has vuelto a por más, ¿eh? Me gusta... 😏";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadChatHistory(); 
            if(botonEnviar) botonEnviar.disabled = false;
            preguntaTextarea.disabled = false;
            preguntaTextarea.focus();
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
        });

        window.addEventListener('beforeunload', () => {
            clearInterval(timerInterval);
            saveChatHistory(); // Guardar al salir
        });

        async function enviarConsulta() {
            const pregunta = preguntaTextarea.value.trim();
            if (!pregunta) {
                displayMessageInLog("¿Te comió la lengua el gato o es que te intimido demasiado? Venga, suelta. 😏", "system");
                return;
            }
            displayMessageInLog(pregunta, "user");
            preguntaTextarea.value = ""; 
            const loadingMessage = "María está maquinando qué decirte... prepárate. 🔥";
            displayMessageInLog(loadingMessage, "system");
            botonEnviar.disabled = true;
            preguntaTextarea.disabled = true;

            currentSystemPrompt = generateDynamicSystemPrompt(getCurrentSliderSettings()); // Actualizar prompt con sliders actuales
            const userMessageForAPI = { role: "user", parts: [{ text: pregunta }] };
            
            // Construir el payload para la API
            // El historial para la API incluye el prompt del sistema, luego el historial de conversación, luego el mensaje actual.
            const apiContents = [
                { role: "user", parts: [{ text: currentSystemPrompt }] }, // Este es el "system prompt"
                ...chatHistory, // Conversación previa (solo user/model)
                userMessageForAPI
            ];
            
            const payload = { contents: apiContents };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Error de la API:", errorData);
                    throw new Error(`Error de la API: ${response.statusText}. Detalles: ${JSON.stringify(errorData)}`);
                }
                const result = await response.json();
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("María está maquinando qué decirte...")) {
                        msg.remove();
                    }
                });

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayMessageInLog(text, "model"); 

                    // Actualizar el historial de conversación (sin el prompt del sistema)
                    chatHistory.push(userMessageForAPI);
                    chatHistory.push({ role: "model", parts: [{ text: text }] });
                    saveChatHistory(); 
                } else {
                    console.warn("Respuesta inesperada de la API o sin contenido:", result);
                    let errorMessage = "Bah, me has pillado en un momento tonto. Repite, si te atreves. 😈";
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        errorMessage = `Parece que te pasaste de listo y me bloqueaste (Razón: ${result.promptFeedback.blockReason})... Intenta con algo menos... obvio, si puedes. 😉`;
                    }
                    displayMessageInLog(errorMessage, "system");
                }
            } catch (error) {
                console.error("Error al generar contenido:", error);
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("María está maquinando qué decirte...")) {
                        msg.remove();
                    }
                });
                displayMessageInLog("Joder, algo petó. ¿Otra vez? O es que no aguantas mi ritmo. 🔥", "system");
            } finally {
                botonEnviar.disabled = false;
                preguntaTextarea.disabled = false;
                preguntaTextarea.focus();
            }
        }
        window.enviarConsulta = enviarConsulta;

        preguntaTextarea.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                enviarConsulta();    
            }
        });
    </script>
</body>
</html>
