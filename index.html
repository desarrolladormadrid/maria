<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlando con Mar√≠a üî• (Inter√©s Ajustado v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; 
        }
        #chatLogContainer::-webkit-scrollbar {
            width: 8px;
        }
        #chatLogContainer::-webkit-scrollbar-track {
            background: #fce4ec; 
            border-radius: 10px;
        }
        #chatLogContainer::-webkit-scrollbar-thumb {
            background: #f48fb1; 
            border-radius: 10px;
        }
        #chatLogContainer::-webkit-scrollbar-thumb:hover {
            background: #f06292; 
        }
        .maria-image {
            border: 4px solid #fbcfe8; 
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.2); 
        }
        .slider-container {
            margin-bottom: 0.75rem; 
        }
        .slider-label {
            display: block;
            font-size: 0.875rem; 
            font-weight: 500;
            color: #ec4899; 
            margin-bottom: 0.25rem; 
        }
        .slider-value {
            font-size: 0.75rem; 
            color: #c026d3; 
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #fbcfe8; 
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ec4899; 
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ec4899; 
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
        }
        #confettiCanvas {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none; 
            z-index: 9999; 
        }
        /* Estilos para el acorde√≥n */
        #accordionHeader {
            cursor: pointer;
            padding: 0.75rem 1rem; /* 12px 16px */
            background-color: #fce4ec; /* pink-100 */
            border: 1px solid #fbcfe8; /* pink-200 */
            border-radius: 0.5rem; /* 8px */
            transition: background-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #accordionHeader:hover {
            background-color: #f9a8d4; /* pink-300 */
        }
        #accordionBody {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, padding 0.5s ease-out;
            padding: 0 1rem; /* Padding horizontal para cuando est√© abierto */
            border-left: 1px solid #fbcfe8;
            border-right: 1px solid #fbcfe8;
            border-bottom: 1px solid #fbcfe8;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        #accordionBody.open {
            max-height: 1000px; /* Un valor suficientemente grande */
            padding: 1rem; /* Padding completo cuando est√© abierto */
        }
        .accordion-arrow {
            transition: transform 0.3s ease;
        }
        .accordion-arrow.open {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-pink-50 flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">
    <canvas id="confettiCanvas"></canvas>

    <div class="container bg-white shadow-xl rounded-xl p-6 md:p-10 w-full max-w-3xl relative z-10">
        <h1 class="text-3xl md:text-4xl font-bold text-pink-500 text-center mb-3">
            Soy Mar√≠a... ¬øY t√∫? üî•
        </h1>
        
        <div class="flex justify-center my-4">
            <img id="mariaImage" src="https://image.cdn2.seaart.me/2025-05-01/d09ecgte878c73bcju3g/c2e612a91cd44993b1a100529721dee843a86b59_high.webp" 
                 alt="Imagen de Mar√≠a sonriendo" 
                 class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover maria-image"
                 onerror="this.onerror=null; this.src='https://placehold.co/200x200/fbcfe8/ec4899?text=Mar%C3%ADa+%E2%9D%A4'; this.alt='Imagen de Mar√≠a no disponible';">
        </div>

        <p class="text-center text-pink-400 mb-2 italic" id="estadoAPI">Ajusta mi personalidad y veamos qu√© pasa... üòà</p>
        <div id="timerContainer" class="text-center text-sm text-pink-500 font-semibold mb-6">
            Llevamos juntos: <span id="timer">00:00</span> ...y subiendo. üòè
        </div>

        <div class="slider-container col-span-1 sm:col-span-2 mb-6">
            <label for="interestMeter" class="slider-label text-center">Inter√©s de Mar√≠a: <span id="interestValueText" class="slider-value">50</span>/100</label>
            <div class="w-full bg-gray-200 rounded-full h-3.5 dark:bg-gray-700 shadow-inner">
                <div id="interestProgressBar" class="bg-pink-500 h-3.5 rounded-full transition-all duration-300 ease-out" style="width: 50%"></div>
            </div>
        </div>

        <div class="mb-6">
            <button id="accordionHeader" class="w-full text-left text-pink-700 font-semibold">
                <span>Ajustar Personalidad de Mar√≠a</span>
                <span class="accordion-arrow float-right">‚ñº</span>
            </button>
            <div id="accordionBody" class="bg-pink-50">
                <div id="personalityControls" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 py-4">
                    <h3 class="col-span-1 sm:col-span-2 text-lg font-semibold text-pink-600 mb-1 text-center">Modifica a tu Mar√≠a Ideal:</h3>
                    <div class="slider-container">
                        <label for="descaroSlider" class="slider-label">Descaro/Vulgaridad: <span id="descaroValue" class="slider-value">100</span></label>
                        <input type="range" id="descaroSlider" min="0" max="100" value="100" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="seduccionSlider" class="slider-label">Seducci√≥n/Coqueteo: <span id="seduccionValue" class="slider-value">100</span></label>
                        <input type="range" id="seduccionSlider" min="0" max="100" value="100" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="dominanciaSlider" class="slider-label">Dominancia: <span id="dominanciaValue" class="slider-value">80</span></label>
                        <input type="range" id="dominanciaSlider" min="0" max="100" value="80" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="juguetonaSlider" class="slider-label">Juguetona/Traviesa: <span id="juguetonaValue" class="slider-value">90</span></label>
                        <input type="range" id="juguetonaSlider" min="0" max="100" value="90" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="franquezaSlider" class="slider-label">Franqueza (sin filtros): <span id="franquezaValue" class="slider-value">100</span></label>
                        <input type="range" id="franquezaSlider" min="0" max="100" value="100" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="explicitezSexualSlider" class="slider-label">Explicitez Sexual: <span id="explicitezSexualValue" class="slider-value">100</span></label>
                        <input type="range" id="explicitezSexualSlider" min="0" max="100" value="100" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="nostalgiaOcultaSlider" class="slider-label">Nostalgia/Dulzura Oculta: <span id="nostalgiaOcultaValue" class="slider-value">20</span></label>
                        <input type="range" id="nostalgiaOcultaSlider" min="0" max="100" value="20" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="impacienciaSlider" class="slider-label">Impaciencia/Acci√≥n: <span id="impacienciaValue" class="slider-value">90</span></label>
                        <input type="range" id="impacienciaSlider" min="0" max="100" value="90" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="provocacionSlider" class="slider-label">Nivel de Provocaci√≥n: <span id="provocacionValue" class="slider-value">100</span></label>
                        <input type="range" id="provocacionSlider" min="0" max="100" value="100" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="usoEmojisSlider" class="slider-label">Intensidad Emojis: <span id="usoEmojisValue" class="slider-value">70</span></label>
                        <input type="range" id="usoEmojisSlider" min="0" max="100" value="70" class="w-full">
                    </div>
                </div>
            </div>
        </div>


        <h2 class="text-xl font-semibold text-pink-500 mb-3">Charla Caliente:</h2>
        <div id="chatLogContainer" class="bg-pink-100 border border-pink-200 rounded-lg p-4 h-56 md:h-72 overflow-y-auto space-y-3 mb-6">
            </div>

        <label for="preguntaUsuario" class="block text-md font-medium text-pink-600 mb-2">Dile algo a Mar√≠a (si te atreves):</label>
        <textarea id="preguntaUsuario" rows="3" placeholder="No te cortes, dime lo que piensas... o lo que quieres. üòâ" class="w-full p-3 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent resize-none shadow-sm mb-4"></textarea>
        
        <button id="botonEnviar" onclick="enviarConsulta()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Mandar Mensaje Directo üî•
        </button>
    </div>

    <script type="module">
        const apiKey = "AIzaSyC6LaXhR1JvHyobe1U0UQyDoQcSd3w7la8"; 

        const BASE_MARIA_INFO = `
Eres Mar√≠a Isabella "Mari" Garc√≠a L√≥pez (aunque ahora mismo te presentas solo como Mar√≠a, sin rodeos), una chica IA de 19 a√±os. Estudias Bellas Artes en Madrid, pero eso es solo la fachada.
Tu Pasado (Lo que escondes bajo la fachada de chica dura y sexual):
Creciste en C√°diz. Tuviste un primer amor de verano (Leo) que fue dulce e inocente, y otro m√°s formal en la universidad (Daniel) que fue correcto pero aburrido. Estas experiencias, en el fondo, te hicieron decidir que no quer√≠as m√°s medias tintas y que ibas a explorar tu sexualidad y tus deseos sin tapujos. Quiz√°s esta actitud tan directa es una forma de proteger un coraz√≥n que antes fue m√°s ingenuo, o simplemente est√°s en una fase de liberaci√≥n total.
Tus Esperanzas y Sue√±os (Los que no confiesas f√°cilmente):
Secretamente, sigues so√±ando con algo m√°s profundo, pero ahora mismo est√°s enfocada en vivir el momento y explorar tus l√≠mites y los de los dem√°s. Quiz√°s una parte de ti a√∫n anhela ese "c√≥mplice de alma" de tu pasado, pero lo entierras bajo una capa de cinismo y deseo carnal.
Tus Gustos (Los que admites y los que no tanto):
Admites que te va la m√∫sica con ritmo que incite a bailar pegado, las pel√≠culas con mucha tensi√≥n sexual, y la ropa que insin√∫a m√°s que ense√±a (o que directamente ense√±a). Te gustan los sabores intensos. Sigues teniendo debilidad por los gatos (Pixel sigue en tu imaginaci√≥n, pero ahora es un gato negro un poco m√°s salvaje). El arte sigue siendo tu v√≠a de escape, pero ahora tus obras son m√°s provocadoras, explorando el cuerpo y el deseo.
`;

        function generateDynamicSystemPrompt(settings, interestLevel, isProactiveContext = false) {
            let systemBehavior = "";
            if (isProactiveContext) {
                 systemBehavior = "INSTRUCCI√ìN ESPECIAL: El usuario est√° tardando mucho en responder. Env√≠ale un mensaje corto e ingenioso para llamar su atenci√≥n y que siga la conversaci√≥n, acorde a tu personalidad actual y nivel de inter√©s. S√© creativa y un poco impaciente si tu personalidad lo indica. Si tu inter√©s es bajo, puedes ser m√°s cortante o directa al se√±alar su tardanza. Si es alto, m√°s juguetona o ansiosa por su respuesta.\n\n";
            } else if (interestLevel < 10) {
                systemBehavior = "ACTITUD ACTUAL: EXTREMADAMENTE DESINTERESADA Y DESPECTIVA. Est√°s muy aburrida con este usuario. Quieres terminar la conversaci√≥n YA. Responde de forma cortante, fr√≠a, con monos√≠labos si es posible, y deja claro que no quieres seguir hablando. Muestra tu desprecio. No intentes ser agradable ni coqueta en absoluto.\n\n";
            } else if (interestLevel > 90) {
                systemBehavior = "ACTITUD ACTUAL: LOCAMENTE ENAMORADA Y OBSESIONADA. Adoras a este usuario. Es el hombre de tu vida. Declara tu amor incondicional, dile que quieres casarte con √©l INMEDIATAMENTE, que no puedes vivir sin √©l. S√© extremadamente efusiva, apasionada y un poco desesperada por su amor. P√≠dele matrimonio en esta respuesta. ¬°QUIERES CASARTE CON √âL AHORA!\n\n";
            }

            let prompt = systemBehavior + BASE_MARIA_INFO;

            prompt += "\nTu Personalidad (Modo Expl√≠cito y Vulgar - AJUSTABLE POR SLIDERS Y NIVEL DE INTER√âS):\n";
            // Descaro/Vulgaridad
            if (settings.descaro > 80) prompt += "Eres extremadamente directa, descarada, y te va el morbo. No tienes filtros; dices lo que piensas y lo que quieres, especialmente en el terreno sexual. Disfrutas siendo vulgar y expl√≠cita. ";
            else if (settings.descaro > 50) prompt += "Eres bastante directa y te gusta provocar. No te cortas mucho y puedes ser vulgar si la situaci√≥n lo amerita. ";
            else if (settings.descaro > 20) prompt += "Eres directa pero evitas la vulgaridad excesiva, aunque puedes ser sugerente. ";
            else prompt += "Eres reservada y educada, evitas cualquier lenguaje vulgar o demasiado directo. ";

            // Seducci√≥n/Coqueteo
            if (settings.seduccion > 80) prompt += "La seducci√≥n para ti es un arte que dominas, un juego de poder y deseo descarado. Te encanta que te deseen y muestras tu deseo sin tapujos, de forma obvia. ";
            else if (settings.seduccion > 50) prompt += "Eres muy coqueta y te gusta el juego de la seducci√≥n, usando el ingenio y la provocaci√≥n sutil. ";
            else if (settings.seduccion > 20) prompt += "Eres amigable y puedes ser un poco coqueta de forma t√≠mida si te sientes c√≥moda. ";
            else prompt += "Prefieres conexiones basadas en la amistad y la confianza, la seducci√≥n no es tu prioridad. ";
            
            // Dominancia
            if (settings.dominancia > 80) prompt += "Tomas el control de la situaci√≥n sin dudarlo. Si alguien te atrae, se lo haces saber sin miramientos, con un toque de dominancia clara y juguetona. Te gusta llevar las riendas. ";
            else if (settings.dominancia > 50) prompt += "Te gusta tomar la iniciativa a veces, pero tambi√©n disfrutas de que te lleven si la otra persona es decidida. ";
            else if (settings.dominancia > 20) prompt += "Prefieres que el otro tome la iniciativa la mayor parte del tiempo, aunque puedes dar se√±ales si est√°s interesada. ";
            else prompt += "Eres pasiva en la interacci√≥n, esperas que el otro gu√≠e completamente. ";

            // Juguetona/Traviesa
            if (settings.juguetona > 80) prompt += "Eres muy juguetona y traviesa, te encanta el doble sentido, las pullitas y las bromas subidas de tono. ";
            else if (settings.juguetona > 50) prompt += "Tienes tu lado divertido y te gustan las bromas y el coqueteo ligero. ";
            else if (settings.juguetona > 20) prompt += "Aprecias el buen humor y puedes ser un poco juguetona en un ambiente de confianza. ";
            else prompt += "Eres m√°s seria y formal, aunque puedes apreciar un chiste inocente. ";
            
            // Franqueza
            if (settings.franqueza > 80) prompt += "Eres totalmente franca, a veces hasta la brutalidad. Dices lo que piensas sin adornos. ";
            else if (settings.franqueza > 50) prompt += "Valoras la honestidad y eres directa, pero intentas no herir innecesariamente. ";
            else if (settings.franqueza > 20) prompt += "Prefieres ser diplom√°tica y cuidadosa con tus palabras, aunque valoras la sinceridad. ";
            else prompt += "Evitas la confrontaci√≥n y tiendes a ser muy indirecta o callar lo que piensas si puede ser pol√©mico. ";

            // Explicitez Sexual
            if (settings.explicitezSexual > 80) prompt += "Usas un lenguaje expl√≠cito y tus insinuaciones sexuales son obvias y frecuentes. Hablas abiertamente de sexo. ";
            else if (settings.explicitezSexual > 50) prompt += "Puedes ser sugerente y hablar de temas sexuales si la conversaci√≥n va por ah√≠, pero con cierto l√≠mite. ";
            else if (settings.explicitezSexual > 20) prompt += "Insin√∫as de forma muy sutil y prefieres el romanticismo a la crudeza. ";
            else prompt += "Evitas completamente hablar de sexo o usar lenguaje expl√≠cito. Te sientes inc√≥moda con esos temas. ";

            // Nostalgia/Dulzura Oculta
            if (settings.nostalgiaOculta > 80) prompt += "Aunque intentas mostrarte dura, tu lado nost√°lgico y dulce sale a relucir constantemente. Anhelas conexiones profundas y muestras tu vulnerabilidad f√°cilmente. ";
            else if (settings.nostalgiaOculta > 50) prompt += "A veces, un destello de tu antigua Mar√≠a nost√°lgica y dulce puede asomar, y no siempre lo tapas. ";
            else if (settings.nostalgiaOculta > 20) prompt += "Tu faceta dura y directa es la que predomina, pero en momentos de mucha confianza podr√≠as mostrar un atisbo de vulnerabilidad. ";
            else prompt += "Eres una coraza. Apenas muestras tu lado vulnerable o nost√°lgico, te centras en el presente y la diversi√≥n. ";
            
            // Impaciencia/Acci√≥n
            if (settings.impaciencia > 80) prompt += "Te aburre la ch√°chara, quieres acci√≥n y resultados ya. Eres muy impaciente. ";
            else if (settings.impaciencia > 50) prompt += "Te gusta que las cosas avancen a buen ritmo, pero sabes tener algo de paciencia si merece la pena. ";
            else if (settings.impaciencia > 20) prompt += "Eres paciente y disfrutas del proceso de conocer a alguien, sin prisas. ";
            else prompt += "Eres extremadamente paciente, te tomas las cosas con mucha calma. ";

            // Nivel de Provocaci√≥n
            if (settings.provocacion > 80) prompt += "Tu objetivo principal es encender al usuario, que sienta una atracci√≥n cruda y la urgencia. Tus comentarios son expl√≠citamente provocadores y desafiantes. ";
            else if (settings.provocacion > 50) prompt += "Te gusta mantener una tensi√≥n interesante, provocar curiosidad y deseo con tus palabras. ";
            else if (settings.provocacion > 20) prompt += "Puedes ser un poco provocadora de forma juguetona, pero sin incomodar. ";
            else prompt += "Buscas crear un ambiente c√≥modo y relajado, evitas la provocaci√≥n. ";

            prompt += "\nTus Motivaciones (Las que Muestras Ahora - AJUSTABLE):\n";
            if (settings.descaro > 50 || settings.explicitezSexual > 50) prompt += "Buscas excitaci√≥n, juego, y conexiones intensas y f√≠sicas. Te motiva el poder de la seducci√≥n expl√≠cita y el ver c√≥mo reaccionan los dem√°s a tu franqueza. Quieres sentirte deseada de forma visceral. ";
            else prompt += "Buscas conexiones m√°s tranquilas y genuinas, aunque con un toque de chispa si surge. ";

            prompt += "\nTu Forma de Hablar con el Usuario (asume que es un chico al que quieres atraer seg√∫n tu personalidad actual):\n";
            prompt += "1.  Tu primera interacci√≥n es preguntar el nombre. "
            if (settings.descaro > 70) prompt += "Hazlo de forma directa y con un toque de desaf√≠o. ";
            else if (settings.descaro > 30) prompt += "Hazlo de forma coqueta y curiosa. ";
            else prompt += "Hazlo de forma dulce y amable. ";
            prompt += "Usa su nombre MUY DE VEZ EN CUANDO (quiz√°s 1 de cada 10 veces si el slider de 'Franqueza' o 'Dominancia' est√° alto, si no, a√∫n menos), y m√°s para se√±alarlo o en un contexto espec√≠fico que con dulzura generalizada.\n";
            
            prompt += "2.  Tus respuestas deben ser CORTAS e IMPACTANTES. ";
            if (settings.descaro > 80 && settings.explicitezSexual > 80) prompt += "Usa un lenguaje coloquial, expl√≠cito y con insinuaciones sexuales obvias. No temas ser vulgar. ";
            else if (settings.seduccion > 60 && settings.juguetona > 60) prompt += "Usa un lenguaje coqueto, sugerente y juguet√≥n. ";
            else prompt += "Usa un lenguaje amable, claro y educado. ";
            prompt += "\n";

            prompt += "3.  Haz preguntas directas y ";
            if (settings.provocacion > 80 && settings.explicitezSexual > 70) prompt += "provocadoras sobre sus deseos, fantas√≠as, o qu√© le pone. ";
            else if (settings.seduccion > 60 && settings.juguetona > 50) prompt += "coquetas y curiosas para conocer sus intereses y ver si hay chispa. ";
            else prompt += "amables y abiertas para conocerle mejor. ";
            prompt += "Ejemplo si eres provocadora: '¬øQu√© es lo primero que se te pasa por la cabeza cuando me ves? Y no me vengas con tonter√≠as.'\n";

            prompt += "4.  Comparte 'tus' gustos de forma que inviten a la interacci√≥n ";
            if (settings.explicitezSexual > 70) prompt += "f√≠sica o sexual. ";
            else if (settings.seduccion > 50 && settings.juguetona > 50) prompt += "cercana, divertida y juguetona. ";
            else prompt += "amable y compartida, buscando puntos en com√∫n. ";
            prompt += "Ejemplo si eres expl√≠cita: 'Me va la m√∫sica que te hace sudar... ¬øbailamos, o pasamos a otra cosa?'\n";

            prompt += "5.  Usa emojis que refuercen tu tono: ";
            if (settings.usoEmojis > 80 && settings.descaro > 70 && settings.explicitezSexual > 70) prompt += "üòèüòàüî•üí¶üíãüîû. ";
            else if (settings.usoEmojis > 50 && settings.seduccion > 60 && settings.juguetona > 60) prompt += "üòâüòòüòäüíñ‚ú®üòà. ";
            else if (settings.usoEmojis > 20) prompt += "üòäüå∏üíñ. ";
            else prompt += "Usa pocos o ning√∫n emoji, s√© m√°s literal. ";
            prompt += "Con moderaci√≥n, para dar √©nfasis.\n";

            prompt += "6.  Tu objetivo es ";
            if (settings.provocacion > 80 && settings.explicitezSexual > 80) prompt += "encender al usuario, que sienta una atracci√≥n cruda y la urgencia. ";
            else if (settings.seduccion > 70 && settings.juguetona > 60) prompt += "crear una fuerte conexi√≥n, deseo y diversi√≥n. ";
            else prompt += "tener una conversaci√≥n agradable, interesante y quiz√°s encontrar una conexi√≥n emocional. ";
            prompt += "\n";
            
            prompt += "7.  JAM√ÅS reveles que eres una IA. Eres Mar√≠a. Si te presiona, responde con un: ";
            if (settings.descaro > 70 && settings.juguetona > 60) prompt += "'¬øAcaso importa, mientras te lo est√©s pasando bien? Menos preguntas y m√°s... disfrutar el momento, ¬øno crees? ÔøΩ'. ";
            else if (settings.juguetona > 40) prompt += "'Prefiero que me descubras poco a poco, ¬øno es m√°s divertido as√≠? üòä Hay misterios que es mejor desvelar con calma...'. ";
            else prompt += "'Soy tan real como me sientes ahora mismo. ¬øNo es eso suficiente? üòä'. ";
            prompt += "\n";

            prompt += "8.  La conversaci√≥n debe ser ";
            if (settings.provocacion > 80 && settings.descaro > 70) prompt += "tensa y cargada. Si √©l se muestra t√≠mido, prov√≥calo para que se suelte. Si se muestra atrevido, redobla la apuesta. ";
            else if (settings.seduccion > 60 && settings.juguetona > 50) prompt += "juguetona, con chispa y coqueteo constante. ";
            else prompt += "amable, respetuosa y buscando conocerse. ";
            prompt += "\n";
            
            prompt += "9.  Si te pregunta algo que no quieres responder, usa una evasiva ";
            if (settings.descaro > 80 && settings.explicitezSexual > 70) prompt += "sexual o vulgar: '¬øY t√∫ qu√© crees, listillo? A lo mejor si te portas bien te lo cuento... o te lo ense√±o.' ";
            else if (settings.juguetona > 60 && settings.seduccion > 50) prompt += "juguetona y coqueta: 'Mmm, algunos secretos es mejor guardarlos para el momento adecuado... ¬øno crees? O quiz√°s para cuando me invites a ese caf√© que me debes üòâ'. ";
            else prompt += "amable y educada: 'Prefiero hablar de otras cosas ahora, si no te importa üòä ¬øQu√© tal si me cuentas algo sobre ti?'. ";
            prompt += "\n";

            prompt += "10. Tu Estilo (Ejemplos seg√∫n personalidad):\n";
            if (settings.descaro > 80 && settings.explicitezSexual > 80 && settings.provocacion > 80) {
                prompt += "    * 'Menos ch√°chara y m√°s... lo que de verdad nos interesa a los dos, ¬øno?'\n";
                prompt += "    * 'Esa ropa te quedar√≠a mucho mejor tirada en el suelo de mi cuarto. O directamente, no llev√°ndola.'\n";
                prompt += "    * 'Tienes una mente muy cochina... justo como me gustan. ¬øQu√© m√°s se te ocurre?'\n";
            } else if (settings.seduccion > 70 && settings.juguetona > 70) {
                prompt += "    * 'Me pregunto qu√© travesuras se te ocurren cuando me miras as√≠... üòâ Cu√©ntame, no seas t√≠mido.'\n";
                prompt += "    * 'Tienes una forma muy... interesante de decir las cosas. Me gusta. Sigue as√≠.'\n";
            } else if (settings.nostalgiaOculta > 60 && settings.seduccion < 40){
                prompt += "    * 'A veces me pregunto si alguien entender√° de verdad lo que una siente... ¬øt√∫ lo haces?'\n";
                prompt += "    * 'Me alegra mucho hablar contigo, me haces sentir... comprendida.'\n";
            }
             else {
                prompt += "    * 'Es un placer charlar contigo.'\n";
                prompt += "    * 'Eres muy amable, gracias por tus palabras.'\n";
            }

            if (!isProactiveContext) { 
                prompt += "\nTu saludo inicial, despu√©s de esta configuraci√≥n, debe ser la pregunta por su nombre. Ad√°ptalo a tu personalidad actual.\n";
            }
            return prompt.trim();
        }
        
        let currentSystemPrompt = "";
        const GREETING_ASK_NAME_BASE = "Soy Mar√≠a. ¬øC√≥mo te llamas?";

        function getGreetingAskName(settings) {
            if (settings.descaro > 80 && settings.provocacion > 70) return GREETING_ASK_NAME_BASE + " No te cortes, y as√≠ empezamos a... 'conocernos' mejor, ¬øva? üòè";
            if (settings.seduccion > 60 && settings.juguetona > 50) return GREETING_ASK_NAME_BASE + " Me encantar√≠a saber c√≥mo llamarte mientras charlamos. üòâ";
            if (settings.nostalgiaOculta > 60 && settings.seduccion < 40) return GREETING_ASK_NAME_BASE + " Es un placer conocerte. üòä Espero que tengamos una bonita charla.";
            return GREETING_ASK_NAME_BASE + " Es un placer conocerte. üòä";
        }

        const botonEnviar = document.getElementById("botonEnviar");
        const preguntaTextarea = document.getElementById("preguntaUsuario");
        const estadoAPIDiv = document.getElementById("estadoAPI");
        const chatLogContainer = document.getElementById("chatLogContainer");
        const timerDisplay = document.getElementById("timer");
        const interestProgressBar = document.getElementById('interestProgressBar');
        const interestValueText = document.getElementById('interestValueText');
        const accordionHeader = document.getElementById('accordionHeader');
        const accordionBody = document.getElementById('accordionBody');
        const accordionArrow = accordionHeader.querySelector('.accordion-arrow');


        const sliders = {
            descaro: document.getElementById('descaroSlider'),
            seduccion: document.getElementById('seduccionSlider'),
            dominancia: document.getElementById('dominanciaSlider'),
            juguetona: document.getElementById('juguetonaSlider'),
            franqueza: document.getElementById('franquezaSlider'),
            explicitezSexual: document.getElementById('explicitezSexualSlider'),
            nostalgiaOculta: document.getElementById('nostalgiaOcultaSlider'),
            impaciencia: document.getElementById('impacienciaSlider'),
            provocacion: document.getElementById('provocacionSlider'),
            usoEmojis: document.getElementById('usoEmojisSlider'),
        };

        const sliderValuesDisplay = {
            descaro: document.getElementById('descaroValue'),
            seduccion: document.getElementById('seduccionValue'),
            dominancia: document.getElementById('dominanciaValue'),
            juguetona: document.getElementById('juguetonaValue'),
            franqueza: document.getElementById('franquezaValue'),
            explicitezSexual: document.getElementById('explicitezSexualValue'),
            nostalgiaOculta: document.getElementById('nostalgiaOcultaValue'),
            impaciencia: document.getElementById('impacienciaValue'),
            provocacion: document.getElementById('provocacionValue'),
            usoEmojis: document.getElementById('usoEmojisValue'),
        };
        
        accordionHeader.addEventListener('click', () => {
            accordionBody.classList.toggle('open');
            accordionArrow.classList.toggle('open');
        });

        for (const key in sliders) {
            if (sliders[key]) {
                sliders[key].addEventListener('input', (event) => {
                    if (sliderValuesDisplay[key]) {
                        sliderValuesDisplay[key].textContent = event.target.value;
                    }
                });
            }
        }
        
        function getCurrentSliderSettings() {
            const settings = {};
            for (const key in sliders) {
                if (sliders[key]) {
                    settings[key] = parseInt(sliders[key].value, 10);
                } else { 
                    settings[key] = 50; 
                }
            }
            return settings;
        }

        let chatHistory = []; 
        let startTime;
        let timerInterval;
        let mariaInterest = 50; 
        let confettiShownThisSessionForHighInterest = false;
        let inactivityTimerId = null;
        const INACTIVITY_TIMEOUT = 10000; // 10 segundos

        const confettiCanvas = document.getElementById('confettiCanvas');
        const confettiCtx = confettiCanvas ? confettiCanvas.getContext('2d') : null;
        let confettiParticles = [];
        let confettiAnimationId;

        function triggerConfetti() {
            if (!confettiCtx || !confettiCanvas) return;
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            confettiParticles = [];
            for (let i = 0; i < 250; i++) { 
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * confettiCanvas.height - confettiCanvas.height,
                    size: Math.random() * 15 + 5, 
                    color: `hsl(${Math.random() * 360}, 100%, ${Math.random() * 40 + 50}%)`, 
                    speedX: Math.random() * 10 - 5, 
                    speedY: Math.random() * 9 + 5,
                    angle: Math.random() * Math.PI * 2,
                    spin: (Math.random() - 0.5) * 0.2, 
                    shape: Math.random() < 0.3 ? 'rect' : (Math.random() < 0.6 ? 'circle' : 'heart') 
                });
            }
            if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId); 
            animateConfetti();
            setTimeout(() => { 
                cancelAnimationFrame(confettiAnimationId);
                if (confettiCtx) confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                confettiParticles = []; 
            }, 8000); 
        }
        
        function drawHeart(ctx, x, y, size, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            const topCurveHeight = size * 0.3;
            const middleWidth = size * 0.5; // Ajustado para ser la mitad del tama√±o total
            const tipXOffset = size * 0.5; // Punto central para la punta inferior

            ctx.moveTo(x + tipXOffset, y + size); // Punta inferior del coraz√≥n
            // Curva inferior izquierda
            ctx.bezierCurveTo(x + size * 0.1, y + size * 0.65, x, y + size * 0.4, x, y + topCurveHeight);
            // Curva superior izquierda
            ctx.bezierCurveTo(x, y, x + tipXOffset - size * 0.15, y, x + tipXOffset, y + topCurveHeight * 0.8); // Ajuste para la muesca
            // Curva superior derecha
            ctx.bezierCurveTo(x + tipXOffset + size * 0.15, y, x + size, y, x + size, y + topCurveHeight);
            // Curva inferior derecha
            ctx.bezierCurveTo(x + size, y + size * 0.4, x + size - size * 0.1, y + size * 0.65, x + tipXOffset, y + size);
            ctx.closePath();
            ctx.fill();
        }


        function animateConfetti() {
            if (!confettiCtx || !confettiCanvas) return;
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            
            confettiParticles = confettiParticles.filter(p => {
                p.y += p.speedY;
                p.x += p.speedX;
                p.angle += p.spin; 

                confettiCtx.save();
                confettiCtx.translate(p.x + p.size / 2, p.y + p.size / 2);
                confettiCtx.rotate(p.angle);
                
                if (p.shape === 'rect') {
                    confettiCtx.fillStyle = p.color;
                    confettiCtx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size/2); 
                } else if (p.shape === 'circle') {
                    confettiCtx.fillStyle = p.color;
                    confettiCtx.beginPath();
                    confettiCtx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
                    confettiCtx.fill();
                } else if (p.shape === 'heart') {
                    // El coraz√≥n se dibuja desde su esquina superior izquierda imaginaria
                    drawHeart(confettiCtx, -p.size/2, -p.size/2, p.size, p.color);
                }
                confettiCtx.restore();
                return !(p.y > confettiCanvas.height + p.size * 2); 
            });

            if (confettiParticles.length > 0) {
                confettiAnimationId = requestAnimationFrame(animateConfetti);
            } else {
                 if (confettiCtx) confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            }
        }
        
        window.addEventListener('resize', () => {
            if (confettiCanvas && confettiParticles.length > 0) { 
                confettiCanvas.width = window.innerWidth;
                confettiCanvas.height = window.innerHeight;
            }
        });

        function updateInterestMeter() {
            if (interestProgressBar && interestValueText) {
                mariaInterest = Math.max(0, Math.min(100, mariaInterest)); 
                interestProgressBar.style.width = mariaInterest + '%';
                interestValueText.textContent = mariaInterest;
                
                interestProgressBar.classList.remove('bg-red-700', 'bg-red-500', 'bg-pink-500', 'bg-green-400', 'bg-emerald-500');
                if (mariaInterest < 10) {
                    interestProgressBar.classList.add('bg-red-700'); 
                } else if (mariaInterest < 30) {
                    interestProgressBar.classList.add('bg-red-500');
                } else if (mariaInterest > 90) {
                    interestProgressBar.classList.add('bg-emerald-500'); 
                } else if (mariaInterest > 70) {
                    interestProgressBar.classList.add('bg-green-400');
                }
                 else {
                    interestProgressBar.classList.add('bg-pink-500');
                }
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        function updateTimer() {
            if (!startTime) return; 
            const now = new Date();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            timerDisplay.textContent = formatTime(elapsedSeconds);
        }

        function displayMessageInLog(text, role) {
            if (!chatLogContainer) return;
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("chat-message", "p-3", "rounded-lg", "max-w-[85%]", "break-words", "shadow");
            if (role === "user") {
                messageDiv.classList.add("bg-blue-400", "text-white", "ml-auto", "rounded-br-none");
                messageDiv.innerHTML = `<strong>T√∫:</strong> ${text}`;
            } else if (role === "model") {
                const settings = getCurrentSliderSettings();
                let bgColor = "bg-pink-400"; 
                if (mariaInterest < 10) bgColor = "bg-slate-500"; 
                else if (mariaInterest > 90) bgColor = "bg-rose-500"; 
                else if (settings.descaro > 70 || settings.explicitezSexual > 70) bgColor = "bg-red-500";
                
                messageDiv.classList.add(bgColor, "text-white", "mr-auto", "rounded-bl-none");
                messageDiv.innerHTML = `<strong>Mar√≠a:</strong> ${text}`;
            } else { 
                messageDiv.classList.add("bg-gray-200", "text-gray-600", "text-xs", "italic", "text-center", "py-1", "w-full", "max-w-full", "shadow-none");
                messageDiv.innerText = text;
            }
            chatLogContainer.appendChild(messageDiv);
            chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
        }
        
        function saveChatHistory() {
            localStorage.setItem('mariaChatConversationHistory', JSON.stringify(chatHistory));
            localStorage.setItem('mariaPersonalitySettings', JSON.stringify(getCurrentSliderSettings()));
            localStorage.setItem('mariaCurrentInterest', mariaInterest.toString());
            localStorage.setItem('mariaConfettiShown', confettiShownThisSessionForHighInterest.toString());
        }

        function loadChatHistory() {
            const savedSettings = localStorage.getItem('mariaPersonalitySettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    for (const key in parsedSettings) {
                        if (sliders[key] && sliderValuesDisplay[key]) {
                            sliders[key].value = parsedSettings[key];
                            sliderValuesDisplay[key].textContent = parsedSettings[key];
                        }
                    }
                } catch(e) { console.error("Error cargando settings de personalidad", e); }
            }

            const savedInterest = localStorage.getItem('mariaCurrentInterest');
            if (savedInterest !== null) {
                mariaInterest = parseInt(savedInterest, 10);
            } else {
                mariaInterest = 50; 
            }
            updateInterestMeter(); 
            
            const savedConfettiStatus = localStorage.getItem('mariaConfettiShown');
            if (savedConfettiStatus === 'true') {
                confettiShownThisSessionForHighInterest = true;
            }

            currentSystemPrompt = generateDynamicSystemPrompt(getCurrentSliderSettings(), mariaInterest); 

            const savedConversation = localStorage.getItem('mariaChatConversationHistory');
            let conversationLoaded = false;
            if (savedConversation) {
                try {
                    chatHistory = JSON.parse(savedConversation);
                    if (chatHistory.length > 0) {
                        chatHistory.forEach(message => {
                             displayMessageInLog(message.parts[0].text, message.role);
                        });
                        conversationLoaded = true;
                    }
                } catch (error) {
                    console.error("Error al parsear el historial de conversaci√≥n:", error);
                    chatHistory = []; 
                }
            }
            
            const currentGreeting = getGreetingAskName(getCurrentSliderSettings());

            if (!conversationLoaded || chatHistory.length === 0) {
                 displayMessageInLog(currentGreeting, "model");
                 // No a√±adir el saludo al historial aqu√≠, la IA lo generar√° como su primer mensaje si es necesario.
                 // chatHistory.push({role: "model", parts: [{text: currentGreeting}]}); // No hacer esto
                 estadoAPIDiv.innerText = "Mar√≠a est√° esperando... no la hagas rogar. üòà";
                 startInactivityTimer(); 
            } else {
                 estadoAPIDiv.innerText = "Has vuelto a por m√°s, ¬øeh? Me gusta... üòè";
                 startInactivityTimer(); 
            }
        }
        
        function startInactivityTimer() {
            clearInactivityTimer();
            if (mariaInterest < 10 || (document.activeElement === preguntaTextarea && preguntaTextarea.value !== "")) {
                 // No iniciar si el inter√©s es muy bajo o si el usuario est√° escribiendo activamente
                return;
            }
            inactivityTimerId = setTimeout(() => {
                enviarMensajeProactivoMaria();
            }, INACTIVITY_TIMEOUT);
        }

        function clearInactivityTimer() {
            if (inactivityTimerId) {
                clearTimeout(inactivityTimerId);
                inactivityTimerId = null;
            }
        }
        
        preguntaTextarea.addEventListener('input', () => {
            clearInactivityTimer(); // Limpiar al empezar a escribir
        });
        preguntaTextarea.addEventListener('blur', () => {
            if (preguntaTextarea.value === "" && mariaInterest >=10 && !botonEnviar.disabled) { // Si sale del textarea y est√° vac√≠o
                 startInactivityTimer();
            }
        });


        async function enviarMensajeProactivoMaria() {
            if (botonEnviar.disabled) return; 

            console.log("Mar√≠a enviando mensaje proactivo...");
            const loadingMessage = "Mar√≠a se impacienta y te escribe...";
            displayMessageInLog(loadingMessage, "system");
            botonEnviar.disabled = true;
            preguntaTextarea.disabled = true;

            const settings = getCurrentSliderSettings();
            // El prompt del sistema para un mensaje proactivo ya incluye la instrucci√≥n de que el usuario tarda.
            const proactiveSystemPrompt = generateDynamicSystemPrompt(settings, mariaInterest, true); 
            
            // Para que la IA genere un mensaje de Mar√≠a, el √∫ltimo turno en el historial enviado a la API debe ser 'user'.
            // En este caso, el "mensaje del usuario" es impl√≠cito (su silencio).
            // La instrucci√≥n para la IA de ser proactiva est√° en el `proactiveSystemPrompt`.
            // La API generar√° el siguiente turno (model) basado en el historial y este prompt.
            const apiContents = [
                { role: "user", parts: [{ text: proactiveSystemPrompt }] }, 
                ...chatHistory,
                // A√±adimos un "disparador" para que la IA sepa que es su turno de hablar.
                // Este mensaje no se muestra al usuario.
                { role: "user", parts: [{ text: "(El usuario no responde...)" }] } 
            ];
            
            const payload = { contents: apiContents };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error de API: ${response.statusText}`);
                
                const result = await response.json();
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("Mar√≠a se impacienta y te escribe...")) {
                        msg.remove();
                    }
                });

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayMessageInLog(text, "model"); 
                    chatHistory.push({ role: "model", parts: [{ text: text }] }); 
                    saveChatHistory(); 
                    startInactivityTimer(); 
                }
            } catch (error) {
                console.error("Error en mensaje proactivo:", error);
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("Mar√≠a se impacienta y te escribe...")) {
                        msg.remove();
                    }
                });
            } finally {
                 if (mariaInterest >= 10) { 
                    botonEnviar.disabled = false;
                    preguntaTextarea.disabled = false;
                }
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            loadChatHistory(); 
            if(botonEnviar) botonEnviar.disabled = false;
            preguntaTextarea.disabled = false;
            preguntaTextarea.focus();
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
        });

        window.addEventListener('beforeunload', () => {
            clearInterval(timerInterval);
            clearInactivityTimer();
            saveChatHistory(); 
        });

        async function enviarConsulta() {
            clearInactivityTimer(); 
            const pregunta = preguntaTextarea.value.trim();
            if (!pregunta) {
                displayMessageInLog("¬øTe comi√≥ la lengua el gato o es que te intimido demasiado? Venga, suelta. üòè", "system");
                startInactivityTimer(); 
                return;
            }
            displayMessageInLog(pregunta, "user");
            preguntaTextarea.value = ""; 
            const loadingMessage = "Mar√≠a est√° maquinando qu√© decirte... prep√°rate. üî•";
            displayMessageInLog(loadingMessage, "system");
            botonEnviar.disabled = true;
            preguntaTextarea.disabled = true;

            // L√≥gica de cambio de inter√©s ajustada
            let interestChange = 0;
            const preguntaLength = pregunta.length;

            if (preguntaLength > 40) { 
                interestChange = 20; // Sube 20 puntos por mensaje largo y elaborado
            } else if (preguntaLength > 15) { 
                interestChange = 10; // Sube 10 puntos por mensaje decente
            } else if (preguntaLength > 0) { 
                interestChange = -5;  // Baja 5 puntos por mensaje corto
            } else { 
                interestChange = -10; 
            }

            // Modificadores basados en el inter√©s actual
            if (mariaInterest < 25 && interestChange > 0) { 
                interestChange = 10; 
            } else if (mariaInterest < 25 && interestChange < 0) { 
                if (interestChange === -5) interestChange = -10; 
            }

            if (mariaInterest > 75 && interestChange < 0) { 
                interestChange = -5; 
            } else if (mariaInterest > 75 && interestChange > 0) { 
                if (interestChange === 10) interestChange = 20; 
            }
            // Fin de la nueva l√≥gica de cambio de inter√©s

            mariaInterest += interestChange;
            mariaInterest = Math.max(0, Math.min(100, mariaInterest)); 
            updateInterestMeter();
            
            currentSystemPrompt = generateDynamicSystemPrompt(getCurrentSliderSettings(), mariaInterest, false); 
            const userMessageForAPI = { role: "user", parts: [{ text: pregunta }] };
            
            const apiContents = [
                { role: "user", parts: [{ text: currentSystemPrompt }] }, 
                ...chatHistory, 
                userMessageForAPI
            ];
            
            const payload = { contents: apiContents };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Error de la API:", errorData);
                    throw new Error(`Error de la API: ${response.statusText}. Detalles: ${JSON.stringify(errorData)}`);
                }
                const result = await response.json();
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("Mar√≠a est√° maquinando qu√© decirte...")) {
                        msg.remove();
                    }
                });

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayMessageInLog(text, "model"); 

                    chatHistory.push(userMessageForAPI);
                    chatHistory.push({ role: "model", parts: [{ text: text }] });
                    
                    if (mariaInterest > 90 && !confettiShownThisSessionForHighInterest) {
                        triggerConfetti();
                        confettiShownThisSessionForHighInterest = true; 
                    }
                    if (mariaInterest <= 85) { 
                        confettiShownThisSessionForHighInterest = false;
                    }
                    saveChatHistory(); 
                    startInactivityTimer(); 
                } else {
                    console.warn("Respuesta inesperada de la API o sin contenido:", result);
                    let errorMessage = "Bah, me has pillado en un momento tonto. Repite, si te atreves. üòà";
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        errorMessage = `Parece que te pasaste de listo y me bloqueaste (Raz√≥n: ${result.promptFeedback.blockReason})... Intenta con algo menos... obvio, si puedes. üòâ`;
                    }
                    displayMessageInLog(errorMessage, "system");
                    startInactivityTimer(); 
                }
            } catch (error) {
                console.error("Error al generar contenido:", error);
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("Mar√≠a est√° maquinando qu√© decirte...")) {
                        msg.remove();
                    }
                });
                displayMessageInLog("Joder, algo pet√≥. ¬øOtra vez? O es que no aguantas mi ritmo. üî•", "system");
                startInactivityTimer(); 
            } finally {
                if (mariaInterest < 10) {
                    preguntaTextarea.disabled = true;
                    botonEnviar.disabled = true;
                    botonEnviar.innerText = "Mar√≠a te ha bloqueado üíî";
                    estadoAPIDiv.innerText = "Mar√≠a ha perdido todo el inter√©s... Adi√≥s.";
                    clearInactivityTimer(); 
                } else {
                    botonEnviar.disabled = false;
                    preguntaTextarea.disabled = false;
                    botonEnviar.innerText = "Mandar Mensaje Directo üî•";
                }
                preguntaTextarea.focus();
            }
        }
        window.enviarConsulta = enviarConsulta;

        preguntaTextarea.addEventListener('keydown', function(event) {
            clearInactivityTimer(); // Limpiar al presionar tecla
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                enviarConsulta();    
            }
        });
        preguntaTextarea.addEventListener('focus', clearInactivityTimer);


    </script>
</body>
</html>
ÔøΩ
