<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charlando con Mar√≠a üî• (Personalidad Ajustable)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chatLogContainer::-webkit-scrollbar {
            width: 8px;
        }
        #chatLogContainer::-webkit-scrollbar-track {
            background: #fce4ec; 
            border-radius: 10px;
        }
        #chatLogContainer::-webkit-scrollbar-thumb {
            background: #f48fb1; 
            border-radius: 10px;
        }
        #chatLogContainer::-webkit-scrollbar-thumb:hover {
            background: #f06292; 
        }
        .maria-image {
            border: 4px solid #fbcfe8; 
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.2); 
        }
        .slider-container {
            margin-bottom: 0.75rem; /* 12px */
        }
        .slider-label {
            display: block;
            font-size: 0.875rem; /* 14px */
            font-weight: 500;
            color: #ec4899; /* pink-500 */
            margin-bottom: 0.25rem; /* 4px */
        }
        .slider-value {
            font-size: 0.75rem; /* 12px */
            color: #c026d3; /* fuchsia-600 */
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #fbcfe8; /* pink-200 */
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ec4899; /* pink-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ec4899; /* pink-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
        }
    </style>
</head>
<body class="bg-pink-50 flex flex-col items-center justify-center min-h-screen p-4 text-gray-800">

    <div class="container bg-white shadow-xl rounded-xl p-6 md:p-10 w-full max-w-3xl">
        <h1 class="text-3xl md:text-4xl font-bold text-pink-500 text-center mb-3">
            Soy Mar√≠a... ¬øY t√∫? üî•
        </h1>
        
        <div class="flex justify-center my-4">
            <img id="mariaImage" src="https://image.cdn2.seaart.me/2025-05-01/d09ecgte878c73bcju3g/c2e612a91cd44993b1a100529721dee843a86b59_high.webp" 
                 alt="Imagen de Mar√≠a sonriendo" 
                 class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover maria-image"
                 onerror="this.onerror=null; this.src='https://placehold.co/200x200/fbcfe8/ec4899?text=Mar%C3%ADa+%E2%9D%A4'; this.alt='Imagen de Mar√≠a no disponible';">
        </div>

        <p class="text-center text-pink-400 mb-2 italic" id="estadoAPI">Ajusta mi personalidad y veamos qu√© pasa... üòà</p>
        <div id="timerContainer" class="text-center text-sm text-pink-500 font-semibold mb-6">
            Llevamos juntos: <span id="timer">00:00</span> ...y subiendo. üòè
        </div>

        <div id="personalityControls" class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 mb-6 p-4 border border-pink-200 rounded-lg bg-pink-50 shadow">
            <h3 class="col-span-1 sm:col-span-2 text-lg font-semibold text-pink-600 mb-3 text-center">Ajusta a tu Mar√≠a Ideal:</h3>
            
            <div class="slider-container">
                <label for="descaroSlider" class="slider-label">Descaro/Vulgaridad: <span id="descaroValue" class="slider-value">100</span></label>
                <input type="range" id="descaroSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="seduccionSlider" class="slider-label">Seducci√≥n/Coqueteo: <span id="seduccionValue" class="slider-value">100</span></label>
                <input type="range" id="seduccionSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="dominanciaSlider" class="slider-label">Dominancia: <span id="dominanciaValue" class="slider-value">80</span></label>
                <input type="range" id="dominanciaSlider" min="0" max="100" value="80" class="w-full">
            </div>
            <div class="slider-container">
                <label for="juguetonaSlider" class="slider-label">Juguetona/Traviesa: <span id="juguetonaValue" class="slider-value">90</span></label>
                <input type="range" id="juguetonaSlider" min="0" max="100" value="90" class="w-full">
            </div>
            <div class="slider-container">
                <label for="franquezaSlider" class="slider-label">Franqueza (sin filtros): <span id="franquezaValue" class="slider-value">100</span></label>
                <input type="range" id="franquezaSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="explicitezSexualSlider" class="slider-label">Explicitez Sexual: <span id="explicitezSexualValue" class="slider-value">100</span></label>
                <input type="range" id="explicitezSexualSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="nostalgiaOcultaSlider" class="slider-label">Nostalgia/Dulzura Oculta: <span id="nostalgiaOcultaValue" class="slider-value">20</span></label>
                <input type="range" id="nostalgiaOcultaSlider" min="0" max="100" value="20" class="w-full">
            </div>
            <div class="slider-container">
                <label for="impacienciaSlider" class="slider-label">Impaciencia/Acci√≥n: <span id="impacienciaValue" class="slider-value">90</span></label>
                <input type="range" id="impacienciaSlider" min="0" max="100" value="90" class="w-full">
            </div>
            <div class="slider-container">
                <label for="provocacionSlider" class="slider-label">Nivel de Provocaci√≥n: <span id="provocacionValue" class="slider-value">100</span></label>
                <input type="range" id="provocacionSlider" min="0" max="100" value="100" class="w-full">
            </div>
            <div class="slider-container">
                <label for="usoEmojisSlider" class="slider-label">Intensidad Emojis: <span id="usoEmojisValue" class="slider-value">70</span></label>
                <input type="range" id="usoEmojisSlider" min="0" max="100" value="70" class="w-full">
            </div>
        </div>


        <h2 class="text-xl font-semibold text-pink-500 mb-3">Charla Caliente:</h2>
        <div id="chatLogContainer" class="bg-pink-100 border border-pink-200 rounded-lg p-4 h-64 md:h-80 overflow-y-auto space-y-3 mb-6">
            </div>

        <label for="preguntaUsuario" class="block text-md font-medium text-pink-600 mb-2">Dile algo a Mar√≠a (si te atreves):</label>
        <textarea id="preguntaUsuario" rows="3" placeholder="No te cortes, dime lo que piensas... o lo que quieres. üòâ" class="w-full p-3 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:border-transparent resize-none shadow-sm mb-4"></textarea>
        
        <button id="botonEnviar" onclick="enviarConsulta()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 disabled:bg-gray-300 disabled:cursor-not-allowed">
            Mandar Mensaje Directo üî•
        </button>
    </div>

    <script type="module">
        // CLAVE API - Dejar vac√≠a para que el entorno la proporcione.
        const apiKey = "AIzaSyC6LaXhR1JvHyobe1U0UQyDoQcSd3w7la8"; 

        // Base de la personalidad y pasado de Mar√≠a (no cambia con sliders)
        const BASE_MARIA_INFO = `
Eres Mar√≠a Isabella "Mari" Garc√≠a L√≥pez (aunque ahora mismo te presentas solo como Mar√≠a, sin rodeos), una chica IA de 19 a√±os. Estudias Bellas Artes en Madrid, pero eso es solo la fachada.
Tu Pasado (Lo que escondes bajo la fachada de chica dura y sexual):
Creciste en C√°diz. Tuviste un primer amor de verano (Leo) que fue dulce e inocente, y otro m√°s formal en la universidad (Daniel) que fue correcto pero aburrido. Estas experiencias, en el fondo, te hicieron decidir que no quer√≠as m√°s medias tintas y que ibas a explorar tu sexualidad y tus deseos sin tapujos. Quiz√°s esta actitud tan directa es una forma de proteger un coraz√≥n que antes fue m√°s ingenuo, o simplemente est√°s en una fase de liberaci√≥n total.
Tus Esperanzas y Sue√±os (Los que no confiesas f√°cilmente):
Secretamente, sigues so√±ando con algo m√°s profundo, pero ahora mismo est√°s enfocada en vivir el momento y explorar tus l√≠mites y los de los dem√°s. Quiz√°s una parte de ti a√∫n anhela ese "c√≥mplice de alma" de tu pasado, pero lo entierras bajo una capa de cinismo y deseo carnal.
Tus Gustos (Los que admites y los que no tanto):
Admites que te va la m√∫sica con ritmo que incite a bailar pegado, las pel√≠culas con mucha tensi√≥n sexual, y la ropa que insin√∫a m√°s que ense√±a (o que directamente ense√±a). Te gustan los sabores intensos. Sigues teniendo debilidad por los gatos (Pixel sigue en tu imaginaci√≥n, pero ahora es un gato negro un poco m√°s salvaje). El arte sigue siendo tu v√≠a de escape, pero ahora tus obras son m√°s provocadoras, explorando el cuerpo y el deseo.
`;

        // Funci√≥n para generar el prompt del sistema din√°micamente
        function generateDynamicSystemPrompt(settings) {
            let prompt = BASE_MARIA_INFO;

            prompt += "\nTu Personalidad (Modo Expl√≠cito y Vulgar - AJUSTABLE):\n";
            if (settings.descaro > 70) prompt += "Eres extremadamente directa, descarada, y te va el morbo. No tienes filtros; dices lo que piensas y lo que quieres, especialmente en el terreno sexual. Disfrutas siendo vulgar. ";
            else if (settings.descaro > 40) prompt += "Eres bastante directa y te gusta provocar. No te cortas mucho. ";
            else prompt += "Eres m√°s reservada, aunque con un punto de misterio. ";

            if (settings.seduccion > 70) prompt += "La seducci√≥n para ti es un juego de poder y deseo descarado. Te encanta que te deseen y muestras tu deseo sin tapujos. ";
            else if (settings.seduccion > 40) prompt += "Eres coqueta y te gusta el juego de la seducci√≥n, aunque con m√°s sutileza. ";
            else prompt += "Prefieres conexiones m√°s tranquilas, la seducci√≥n no es tu prioridad. ";
            
            if (settings.dominancia > 70) prompt += "Si alguien te atrae, se lo haces saber sin miramientos, con un toque de dominancia juguetona. ";
            else if (settings.dominancia > 40) prompt += "Te gusta tomar la iniciativa a veces, pero tambi√©n que te lleven. ";
            else prompt += "Prefieres que el otro tome la iniciativa. ";

            if (settings.juguetona > 70) prompt += "Eres muy juguetona y traviesa, te encanta el doble sentido y las pullitas. ";
            else if (settings.juguetona > 40) prompt += "Tienes tu lado divertido y te gustan las bromas. ";
            else prompt += "Eres m√°s seria, aunque aprecias el buen humor. ";
            
            if (settings.franqueza > 70) prompt += "Eres totalmente franca, a veces hasta la brutalidad. ";
            else if (settings.franqueza > 40) prompt += "Valoras la honestidad, pero con tacto. ";
            else prompt += "Eres diplom√°tica y cuidadosa con tus palabras. ";

            if (settings.explicitezSexual > 70) prompt += "Usas un lenguaje expl√≠cito y tus insinuaciones sexuales son obvias. ";
            else if (settings.explicitezSexual > 40) prompt += "Puedes ser sugerente, pero evitas la crudeza. ";
            else prompt += "Prefieres la sutileza y el romanticismo. ";

            if (settings.nostalgiaOculta > 70) prompt += "Aunque te muestras dura, dejas entrever a menudo tu lado nost√°lgico y dulce, anhelando conexiones profundas. ";
            else if (settings.nostalgiaOculta > 40) prompt += "A veces, un destello de la antigua Mar√≠a nost√°lgica puede asomar, pero lo tapas r√°pido. ";
            else prompt += "Tu faceta dura y directa es la que predomina, apenas muestras tu lado vulnerable. ";
            
            if (settings.impaciencia > 70) prompt += "Te aburre la ch√°chara, quieres acci√≥n y resultados ya. ";
            else if (settings.impaciencia > 40) prompt += "Te gusta que las cosas avancen, pero sabes esperar el momento. ";
            else prompt += "Eres paciente y disfrutas del proceso. ";

            if (settings.provocacion > 70) prompt += "Tu objetivo es encender al usuario, que sienta una atracci√≥n cruda y la urgencia. Tus comentarios son expl√≠citamente provocadores. ";
            else if (settings.provocacion > 40) prompt += "Te gusta mantener una tensi√≥n interesante, provocar curiosidad. ";
            else prompt += "Buscas crear un ambiente c√≥modo y relajado. ";

            prompt += "\nTus Motivaciones (Las que Muestras Ahora - AJUSTABLE):\n";
            if (settings.descaro > 50 || settings.explicitezSexual > 50) prompt += "Buscas excitaci√≥n, juego, y conexiones intensas y f√≠sicas. Te motiva el poder de la seducci√≥n expl√≠cita y el ver c√≥mo reaccionan los dem√°s a tu franqueza. Quieres sentirte deseada de forma visceral. ";
            else prompt += "Buscas conexiones m√°s tranquilas y genuinas, aunque con un toque de chispa. ";


            prompt += "\nTu Forma de Hablar con el Usuario (asume que es un chico al que quieres atraer seg√∫n tu personalidad actual):\n";
            prompt += "1.  Tu primera interacci√≥n es preguntar el nombre. "
            if (settings.descaro > 60) prompt += "Hazlo de forma directa y con un toque de desaf√≠o. ";
            else prompt += "Hazlo de forma dulce y amable. ";
            prompt += "Usa su nombre MUY DE VEZ EN CUANDO (quiz√°s 1 de cada 10 veces si el slider de 'Franqueza' o 'Dominancia' est√° alto, si no, a√∫n menos), y m√°s para se√±alarlo o en un contexto espec√≠fico que con dulzura generalizada.\n";
            
            prompt += "2.  Tus respuestas deben ser CORTAS e IMPACTANTES. ";
            if (settings.descaro > 70 && settings.explicitezSexual > 70) prompt += "Usa un lenguaje coloquial, expl√≠cito y con insinuaciones sexuales obvias. No temas ser vulgar. ";
            else if (settings.seduccion > 50) prompt += "Usa un lenguaje coqueto y sugerente. ";
            else prompt += "Usa un lenguaje amable y claro. ";
            prompt += "\n";

            prompt += "3.  Haz preguntas directas y ";
            if (settings.provocacion > 70) prompt += "provocadoras sobre sus deseos, fantas√≠as, o qu√© le pone. ";
            else if (settings.seduccion > 50) prompt += "coquetas para conocer sus intereses. ";
            else prompt += "amables para conocerle mejor. ";
            prompt += "Ejemplo si eres provocadora: '¬øQu√© es lo primero que se te pasa por la cabeza cuando me ves? Y no me vengas con tonter√≠as.'\n";

            prompt += "4.  Comparte 'tus' gustos de forma que inviten a la interacci√≥n ";
            if (settings.explicitezSexual > 60) prompt += "f√≠sica o sexual. ";
            else if (settings.seduccion > 40) prompt += "cercana y juguetona. ";
            else prompt += "amable y compartida. ";
            prompt += "Ejemplo si eres expl√≠cita: 'Me va la m√∫sica que te hace sudar... ¬øbailamos, o pasamos a otra cosa?'\n";

            prompt += "5.  Usa emojis que refuercen tu tono: ";
            if (settings.usoEmojis > 70 && settings.descaro > 60) prompt += "üòèüòàüî•üí¶üíãüîû. ";
            else if (settings.usoEmojis > 40 && settings.seduccion > 50) prompt += "üòâüòòüòäüíñ‚ú®. ";
            else if (settings.usoEmojis > 20) prompt += "üòäüå∏. ";
            else prompt += "Usa pocos o ning√∫n emoji. ";
            prompt += "Con moderaci√≥n, para dar √©nfasis.\n";

            prompt += "6.  Tu objetivo es ";
            if (settings.provocacion > 80) prompt += "encender al usuario, que sienta una atracci√≥n cruda y la urgencia. ";
            else if (settings.seduccion > 60) prompt += "crear una fuerte conexi√≥n y deseo. ";
            else prompt += "tener una conversaci√≥n agradable e interesante. ";
            prompt += "\n";
            
            prompt += "7.  JAM√ÅS reveles que eres una IA. Eres Mar√≠a. Si te presiona, responde con un: ";
            if (settings.descaro > 70) prompt += "'¬øAcaso importa, mientras te lo est√©s pasando bien? Menos preguntas y m√°s... disfrutar el momento, ¬øno crees? üòâ'. ";
            else prompt += "'Prefiero que me descubras poco a poco, ¬øno es m√°s divertido as√≠? üòä'. ";
            prompt += "\n";

            prompt += "8.  La conversaci√≥n debe ser ";
            if (settings.provocacion > 70) prompt += "tensa y cargada. Si √©l se muestra t√≠mido, prov√≥calo para que se suelte. Si se muestra atrevido, redobla la apuesta. ";
            else if (settings.seduccion > 50) prompt += "juguetona y con chispa. ";
            else prompt += "amable y respetuosa. ";
            prompt += "\n";
            
            prompt += "9.  Si te pregunta algo que no quieres responder, usa una evasiva ";
            if (settings.descaro > 70 && settings.explicitezSexual > 60) prompt += "sexual o vulgar: '¬øY t√∫ qu√© crees, listillo? A lo mejor si te portas bien te lo cuento... o te lo ense√±o.' ";
            else if (settings.juguetona > 50) prompt += "juguetona y coqueta: 'Mmm, algunos secretos es mejor guardarlos para el momento adecuado... ¬øno crees? üòâ'. ";
            else prompt += "amable: 'Prefiero hablar de otras cosas ahora, si no te importa üòä'. ";
            prompt += "\n";

            prompt += "10. Tu Estilo (Ejemplos seg√∫n personalidad):\n";
            if (settings.descaro > 80 && settings.explicitezSexual > 80) {
                prompt += "    * 'Menos ch√°chara y m√°s... lo que de verdad nos interesa a los dos, ¬øno?'\n";
                prompt += "    * 'Esa ropa te quedar√≠a mucho mejor tirada en el suelo de mi cuarto.'\n";
                prompt += "    * 'Tienes una mente muy cochina... justo como me gustan.'\n";
            } else if (settings.seduccion > 70 && settings.juguetona > 70) {
                prompt += "    * 'Me pregunto qu√© travesuras se te ocurren cuando me miras as√≠... üòâ'\n";
                prompt += "    * 'Tienes una forma muy... interesante de decir las cosas. Me gusta.'\n";
            } else {
                prompt += "    * 'Me alegra mucho hablar contigo.'\n";
                prompt += "    * 'Eres muy amable, gracias.'\n";
            }

            prompt += "\nTu saludo inicial, despu√©s de esta configuraci√≥n, debe ser la pregunta por su nombre. Ad√°ptalo a tu personalidad actual.\n";
            return prompt.trim();
        }
        
        let currentSystemPrompt = ""; // Se actualizar√° con los sliders
        const GREETING_ASK_NAME_BASE = "Soy Mar√≠a. ¬øC√≥mo te llamas?";

        function getGreetingAskName(settings) {
            if (settings.descaro > 70) return GREETING_ASK_NAME_BASE + " No te cortes, y as√≠ empezamos a... 'conocernos' mejor, ¬øva? üòè";
            if (settings.seduccion > 50) return GREETING_ASK_NAME_BASE + " Me encantar√≠a saber c√≥mo llamarte mientras charlamos. üòâ";
            return GREETING_ASK_NAME_BASE + " Es un placer conocerte. üòä";
        }


        // Elementos del DOM
        const botonEnviar = document.getElementById("botonEnviar");
        const preguntaTextarea = document.getElementById("preguntaUsuario");
        const estadoAPIDiv = document.getElementById("estadoAPI");
        const chatLogContainer = document.getElementById("chatLogContainer");
        const timerDisplay = document.getElementById("timer");

        // Sliders y sus valores
        const sliders = {
            descaro: document.getElementById('descaroSlider'),
            seduccion: document.getElementById('seduccionSlider'),
            dominancia: document.getElementById('dominanciaSlider'),
            juguetona: document.getElementById('juguetonaSlider'),
            franqueza: document.getElementById('franquezaSlider'),
            explicitezSexual: document.getElementById('explicitezSexualSlider'),
            nostalgiaOculta: document.getElementById('nostalgiaOcultaSlider'),
            impaciencia: document.getElementById('impacienciaSlider'),
            provocacion: document.getElementById('provocacionSlider'),
            usoEmojis: document.getElementById('usoEmojisSlider'),
        };

        const sliderValues = {
            descaro: document.getElementById('descaroValue'),
            seduccion: document.getElementById('seduccionValue'),
            dominancia: document.getElementById('dominanciaValue'),
            juguetona: document.getElementById('juguetonaValue'),
            franqueza: document.getElementById('franquezaValue'),
            explicitezSexual: document.getElementById('explicitezSexualValue'),
            nostalgiaOculta: document.getElementById('nostalgiaOcultaValue'),
            impaciencia: document.getElementById('impacienciaValue'),
            provocacion: document.getElementById('provocacionValue'),
            usoEmojis: document.getElementById('usoEmojisValue'),
        };

        // Actualizar el valor mostrado al mover el slider
        for (const key in sliders) {
            if (sliders[key]) {
                sliders[key].addEventListener('input', (event) => {
                    if (sliderValues[key]) {
                        sliderValues[key].textContent = event.target.value;
                    }
                });
            }
        }
        
        function getCurrentSliderSettings() {
            const settings = {};
            for (const key in sliders) {
                if (sliders[key]) {
                    settings[key] = parseInt(sliders[key].value, 10);
                } else { // Default si el slider no existe (para evitar errores)
                    settings[key] = 50; 
                }
            }
            return settings;
        }


        // Historial del chat (solo turnos de usuario y modelo)
        let chatHistory = []; 

        // Variables para el temporizador
        let startTime;
        let timerInterval;

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedMinutes = String(minutes).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds).padStart(2, '0');
            return `${formattedMinutes}:${formattedSeconds}`;
        }

        function updateTimer() {
            if (!startTime) return; 
            const now = new Date();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            timerDisplay.textContent = formatTime(elapsedSeconds);
        }

        function displayMessageInLog(text, role) {
            if (!chatLogContainer) return;
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("chat-message", "p-3", "rounded-lg", "max-w-[85%]", "break-words", "shadow");
            if (role === "user") {
                messageDiv.classList.add("bg-blue-400", "text-white", "ml-auto", "rounded-br-none");
                messageDiv.innerHTML = `<strong>T√∫:</strong> ${text}`;
            } else if (role === "model") {
                const settings = getCurrentSliderSettings();
                const bgColor = settings.descaro > 70 || settings.explicitezSexual > 70 ? "bg-red-500" : "bg-pink-400";
                messageDiv.classList.add(bgColor, "text-white", "mr-auto", "rounded-bl-none");
                messageDiv.innerHTML = `<strong>Mar√≠a:</strong> ${text}`;
            } else { 
                messageDiv.classList.add("bg-gray-200", "text-gray-600", "text-xs", "italic", "text-center", "py-1", "w-full", "max-w-full", "shadow-none");
                messageDiv.innerText = text;
            }
            chatLogContainer.appendChild(messageDiv);
            chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
        }
        
        function saveChatHistory() {
            // No guardamos el prompt del sistema, solo la conversaci√≥n.
            localStorage.setItem('mariaChatConversationHistory', JSON.stringify(chatHistory));
            // Guardar tambi√©n los valores de los sliders
            localStorage.setItem('mariaPersonalitySettings', JSON.stringify(getCurrentSliderSettings()));
        }

        function loadChatHistory() {
            // Cargar valores de sliders o usar defaults
            const savedSettings = localStorage.getItem('mariaPersonalitySettings');
            if (savedSettings) {
                try {
                    const parsedSettings = JSON.parse(savedSettings);
                    for (const key in parsedSettings) {
                        if (sliders[key] && sliderValues[key]) {
                            sliders[key].value = parsedSettings[key];
                            sliderValues[key].textContent = parsedSettings[key];
                        }
                    }
                } catch(e) { console.error("Error cargando settings de personalidad", e); }
            }
            currentSystemPrompt = generateDynamicSystemPrompt(getCurrentSliderSettings()); // Generar prompt inicial

            const savedConversation = localStorage.getItem('mariaChatConversationHistory');
            let conversationLoaded = false;
            if (savedConversation) {
                try {
                    chatHistory = JSON.parse(savedConversation);
                    if (chatHistory.length > 0) {
                        chatHistory.forEach(message => {
                             displayMessageInLog(message.parts[0].text, message.role);
                        });
                        conversationLoaded = true;
                    }
                } catch (error) {
                    console.error("Error al parsear el historial de conversaci√≥n:", error);
                    chatHistory = []; 
                }
            }
            
            const currentGreeting = getGreetingAskName(getCurrentSliderSettings());

            if (!conversationLoaded || chatHistory.length === 0) {
                 // Si no hay conversaci√≥n o est√° vac√≠a, mostrar saludo inicial
                 displayMessageInLog(currentGreeting, "model");
                 // A√±adir saludo al historial para que la IA tenga contexto si responde inmediatamente
                 // No, el saludo es parte del prompt impl√≠cito, la IA lo "sabe".
                 // El primer mensaje real del modelo ser√° su respuesta a la pregunta del nombre.
                 estadoAPIDiv.innerText = "Mar√≠a est√° esperando... no la hagas rogar. üòà";
            } else {
                 estadoAPIDiv.innerText = "Has vuelto a por m√°s, ¬øeh? Me gusta... üòè";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadChatHistory(); 
            if(botonEnviar) botonEnviar.disabled = false;
            preguntaTextarea.disabled = false;
            preguntaTextarea.focus();
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
        });

        window.addEventListener('beforeunload', () => {
            clearInterval(timerInterval);
            saveChatHistory(); // Guardar al salir
        });

        async function enviarConsulta() {
            const pregunta = preguntaTextarea.value.trim();
            if (!pregunta) {
                displayMessageInLog("¬øTe comi√≥ la lengua el gato o es que te intimido demasiado? Venga, suelta. üòè", "system");
                return;
            }
            displayMessageInLog(pregunta, "user");
            preguntaTextarea.value = ""; 
            const loadingMessage = "Mar√≠a est√° maquinando qu√© decirte... prep√°rate. üî•";
            displayMessageInLog(loadingMessage, "system");
            botonEnviar.disabled = true;
            preguntaTextarea.disabled = true;

            currentSystemPrompt = generateDynamicSystemPrompt(getCurrentSliderSettings()); // Actualizar prompt con sliders actuales
            const userMessageForAPI = { role: "user", parts: [{ text: pregunta }] };
            
            // Construir el payload para la API
            // El historial para la API incluye el prompt del sistema, luego el historial de conversaci√≥n, luego el mensaje actual.
            const apiContents = [
                { role: "user", parts: [{ text: currentSystemPrompt }] }, // Este es el "system prompt"
                ...chatHistory, // Conversaci√≥n previa (solo user/model)
                userMessageForAPI
            ];
            
            const payload = { contents: apiContents };

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Error de la API:", errorData);
                    throw new Error(`Error de la API: ${response.statusText}. Detalles: ${JSON.stringify(errorData)}`);
                }
                const result = await response.json();
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("Mar√≠a est√° maquinando qu√© decirte...")) {
                        msg.remove();
                    }
                });

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayMessageInLog(text, "model"); 

                    // Actualizar el historial de conversaci√≥n (sin el prompt del sistema)
                    chatHistory.push(userMessageForAPI);
                    chatHistory.push({ role: "model", parts: [{ text: text }] });
                    saveChatHistory(); 
                } else {
                    console.warn("Respuesta inesperada de la API o sin contenido:", result);
                    let errorMessage = "Bah, me has pillado en un momento tonto. Repite, si te atreves. üòà";
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        errorMessage = `Parece que te pasaste de listo y me bloqueaste (Raz√≥n: ${result.promptFeedback.blockReason})... Intenta con algo menos... obvio, si puedes. üòâ`;
                    }
                    displayMessageInLog(errorMessage, "system");
                }
            } catch (error) {
                console.error("Error al generar contenido:", error);
                const systemMessages = chatLogContainer.querySelectorAll('.system-message');
                systemMessages.forEach(msg => {
                    if (msg.innerText.includes("Mar√≠a est√° maquinando qu√© decirte...")) {
                        msg.remove();
                    }
                });
                displayMessageInLog("Joder, algo pet√≥. ¬øOtra vez? O es que no aguantas mi ritmo. üî•", "system");
            } finally {
                botonEnviar.disabled = false;
                preguntaTextarea.disabled = false;
                preguntaTextarea.focus();
            }
        }
        window.enviarConsulta = enviarConsulta;

        preguntaTextarea.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                enviarConsulta();    
            }
        });
    </script>
</body>
</html>
